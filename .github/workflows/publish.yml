name: Publish Docker Image

on:
  schedule: # Every 6 hours, on the 22nd minute to avoid Github action congestion
    - cron: '22 */6 * * *'
  workflow_dispatch: # Allows manual triggering without inputs

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get latest version
        id: npm
        run: |
          VERSION=$(npm show @mariozechner/pi-coding-agent version --no-update-notifier | head -n 1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if image exists
        id: check_image
        run: |
          TARGET=${{ steps.npm.outputs.version }}
          # Check if tag exists on Docker Hub
          TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:michaelwadman/pi-agent:pull" | jq -r .token)
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" -H "Authorization: Bearer $TOKEN" "https://index.docker.io/v2/michaelwadman/pi-agent/manifests/$TARGET")

          if [ "$HTTP_STATUS" -eq "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Image michaelwadman/pi-agent:$TARGET already exists."
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image michaelwadman/pi-agent:$TARGET does not exist. Proceeding with build."
          fi

      - name: Set up QEMU
        if: steps.check_image.outputs.exists == 'false'
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        if: steps.check_image.outputs.exists == 'false'
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        if: steps.check_image.outputs.exists == 'false'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push
        if: steps.check_image.outputs.exists == 'false'
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            PI_VERSION=${{ steps.npm.outputs.version }}
          tags: |
            michaelwadman/pi-agent:${{ steps.npm.outputs.version }}
            michaelwadman/pi-agent:latest
